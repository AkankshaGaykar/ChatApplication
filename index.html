<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Web Chat (Java Backend)</title>
  <style>
    body {
      font-family: system-ui, Arial;
      max-width: 900px;
      margin: 20px auto;
      background: #d2ebd3; /* Solid background */
    }

    header {
      background: #075E54;
      color: white;
      padding: 10px 15px;
      border-radius: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    #chat {
      height: 450px;
      overflow-y: auto;
      background: #e5ddd5; /* Chat area solid color */
      padding: 12px;
      border-radius: 12px;
    }

    .msg {
      max-width: 60%;
      padding: 10px 12px;
      border-radius: 12px;
      margin: 10px 0;
      display: flex;
      align-items: center;
      gap: 8px;
      background: #ffffff;
      border: 1px solid #ccc;
    }

    .me {
      background: #DCF8C6; /* Sent Message Bubble */
      margin-left: auto;
      border: 1px solid #b2d8a9;
    }

    .avatar {
      width: 28px;
      height: 28px;
      border-radius: 50%;
    }

    #form {
      display: flex;
      gap: 8px;
      margin-top: 12px;
    }

    input[type=text] {
      flex: 1;
      padding: 12px;
      border-radius: 8px;
      border: 1px solid #ccc;
    }

    button {
      padding: 10px 18px;
      border: none;
      border-radius: 8px;
      background: #128C7E;
      color: white;
      cursor: pointer;
      font-size: 15px;
    }

    button:hover { 
      background: #0d6d63;
    }
  </style>
</head>

<body>

<header>
  <h3>WhatsApp Style Chat</h3>
  <div>Server: <strong>http://localhost:8000</strong></div>
</header>

<div id="chat"></div>

<div id="form">
  <input id="name" placeholder="Your name" value="Me">
  <input id="msg" placeholder="Type a message">
  <button id="send">Send</button>
</div>

<script>
const chat = document.getElementById('chat');
const nameInput = document.getElementById('name');
const msgInput = document.getElementById('msg');
const sendBtn = document.getElementById('send');

/* ✅ Add messages properly as bubbles */


  function addLine(text) {
  let msgData;

  try {
    msgData = JSON.parse(text); // If valid JSON
  } catch {
    // ✅ Fallback: show normal messages from server
    const d = document.createElement('div');
    d.className = 'msg';
    d.textContent = text;
    chat.appendChild(d);
    chat.scrollTop = chat.scrollHeight;
    return;
  }

  const d = document.createElement('div');
  const isMe = msgData.name === nameInput.value;
  d.className = 'msg ' + (isMe ? 'me' : '');

  const avatar = document.createElement('img');
  avatar.className = "avatar";
  avatar.src = isMe
    ? "https://cdn-icons-png.flaticon.com/512/1946/1946429.png"
    : "https://cdn-icons-png.flaticon.com/512/456/456212.png";

  const t = document.createElement('span');
  t.textContent = msgData.name + ": " + msgData.message;

  d.appendChild(avatar);
  d.appendChild(t);

  chat.appendChild(d);
  chat.scrollTop = chat.scrollHeight;
}


/* ✅ SSE event listener (receives messages) */
const es = new EventSource('/events');
es.addEventListener('message', function(e) {
  addLine(e.data);
});
es.onerror = function() {
  console.log("Server connection lost.");
  es.close();
};

/* ✅ Send message */
function send() {
  const name = nameInput.value.trim() || "Me";
  const message = msgInput.value.trim();
  if (!message) return;

  fetch('/send', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({name, message})
  });

  msgInput.value = "";
}

sendBtn.addEventListener('click', send);
msgInput.addEventListener('keydown', (e)=>{ if(e.key === 'Enter') send(); });
</script>

</body>
</html>
